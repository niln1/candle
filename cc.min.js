// CandlestickChart
// Renders midpoint based candlesticks as a candlestick chart.
// NilN1, 2013
function CandlestickChart(){}google.charts.load("current",{packages:["corechart","controls"]}),CandlestickChart.prototype.render=function(){function n(e){var t=new Date(e),n=""+(t.getMonth()+1),r=""+t.getDate(),i=t.getFullYear();return n.length<2&&(n="0"+n),r.length<2&&(r="0"+r),[i,n,r].join("-")}function r(e,t){t||(t=window.location.href),e=e.replace(/[\[\]]/g,"\\$&");var n=new RegExp("[?&]"+e+"(=([^&#]*)|&|#|$)"),r=n.exec(t);return r?r[2]?decodeURIComponent(r[2].replace(/\+/g," ")):"":null}function i(t){var i=r("tag")?r("tag"):"TWTR",s=Number(r("tspan")?r("tspan"):"30"),o=new Date,u=n(o),f=n((new Date).setDate(o.getDate()-s));$("#csdate").text(f),$("#csymbol").text(i),$("#tag").val(i),$("#tspan").val(s),$("#tag").on("change",function(){document.forms.yo.submit()}),$("#tspan").on("change",function(){document.forms.yo.submit()}),$.get("https://query.yahooapis.com/v1/public/yql?q=select%20*%20from%20yahoo.finance.historicaldata%20where%20symbol%20%3D%20%22"+i+"%22%20and%20startDate%20%3D%20%22"+f+"%22%20and%20endDate%20%3D%20%22"+u+"%22%20&format=json&diagnostics=true&env=store%3A%2F%2Fdatatables.org%2Falltableswithkeys&callback=",function(t){function s(t){var n=e.getSortedRows([{column:1}]),r=e.getValue(n[t],1);return{x:n[t],y:r}}function o(e,t,n,r){var i=e;try{var s=r.getValue(t-1,n),o=r.getValue(t+1,n);return o>i&&s>i?!0:!1}catch(u){return!1}}function u(e,t,n,r){var i=e;try{var s=r.getValue(t-1,n),o=r.getValue(t+1,n);return o<i&&s<i?!0:!1}catch(u){return!1}}function f(e){var t=e.getFilteredRows([{column:1,test:o}]);return t}function c(e){var t=e.getFilteredRows([{column:4,test:u}]);return t}function h(e){var t=i.getChartLayoutInterface(),n=t.getChartAreaBoundingBox(),r=c(e),s=r.map(function(e){return m(e,4)});p(s,function(e,n){if(e.y<n.y){var r=g(e,t,"red-dot"),i=g(n,t,"red-dot"),s=a(r,i).getY,o=d(e,n,function(e){var n=g(m(e,2),t,"");return n.Y<s(n.X)?!0:!1});o==="invalid"?l(i,s,"black",.1):o===!1&&l(i,s,"black")}});var o=s.map(function(e){return g(e,t,"red-dot")}),u=document.querySelector("#chart > div > div");o.forEach(function(e){u.appendChild(e)})}function p(e,t){for(var n=0;n<e.length;n++)for(var r=n+1;r<e.length;r++){var i=e[n],s=e[r];t(i,s)}}function d(e,t,n){var r=!1;for(var i=t.x-1;i>=0;i--)i>e.x?n(i)&&(r=!0):n(i)&&r===!1&&(r="invalid");return r}function v(e){var t=i.getChartLayoutInterface(),n=t.getChartAreaBoundingBox(),r=f(e),s=r.map(function(e){return m(e,1)});p(s,function(e,n){if(e.y>n.y){var r=g(e,t,"green-dot"),i=g(n,t,"green-dot"),s=a(r,i).getY,o=d(e,n,function(e){var n=g(m(e,2),t,"");return n.Y>s(n.X)?!0:!1});o==="invalid"?l(i,s,"black",.1):o===!1&&l(i,s,"black")}});var o=s.map(function(e){return g(e,t,"green-dot")}),u=document.querySelector("#chart > div > div");o.forEach(function(e){u.appendChild(e)})}function m(t,n){var r=e.getValue(t,n);return{x:t,y:r}}function g(e,t,n){var r=e.x,i=e.y,s=t.getYLocation(i),o=t.getXLocation(r),u=document.createElement("div");return u.style.top=s+"px",u.style.left=o+"px",u.className=n,u.X=o,u.Y=s,u}console.log(t);var n=t.query.results.quote;n.forEach(function(t,n){e.addRow([t.Date,Number(t.Low),Number(t.Close),Number(t.Open),Number(t.High)])});var r={legend:"none",hAxis:{direction:-1}},i=new google.visualization.CandlestickChart(document.getElementById("chart"));google.visualization.events.addListener(i,"ready",h.bind(i,e)),google.visualization.events.addListener(i,"ready",v.bind(i,e)),i.draw(e,r)})}function s(e,n){t.chartOpts.title=t.instrument+" Candlesticks",n&&(t.chartOpts.animation={duration:1e3,easing:"out"}),t.chartOpts.candlestick={fallingColor:{strokeWidth:0,fill:"#a52714",stroke:"#a52714"},risingColor:{strokeWidth:0,fill:"#0f9d58",stroke:"#0f9d58"}},t.chart.setOptions(t.chartOpts),t.chart.draw(e)}function u(e,t,n){var n=n?n:"black",r=o.append("line").attr("x1",e.X).attr("y1",e.Y).attr("x2",t.X).attr("y2",t.Y).attr("stroke-width",1).attr("stroke",n)}function a(e,t){function i(e){return n*e+r}function s(e){return(e-r)/n}var n=(t.Y-e.Y)/(t.X-e.X),r=t.Y-n*t.X;return{getY:i,geyX:s}}function f(e,t,n){var t=t?t:"black",n=n?n:1,r=o.append("line").attr("x1",0).attr("y1",e(0)).attr("x2",window.innerWidth).attr("y2",e(window.innerWidth)).attr("stroke-width",1).attr("stroke",t).attr("stroke-opacity",n)}function l(e,t,n,r){var n=n?n:"black",r=r?r:1,i=o.append("line").attr("x1",e.X).attr("y1",e.Y).attr("x2",window.innerWidth).attr("y2",t(window.innerWidth)).attr("stroke-width",.5).attr("stroke",n).attr("stroke-opacity",r)}var e=new google.visualization.DataTable;e.addColumn("string","Date"),e.addColumn("number","Low"),e.addColumn("number","Close"),e.addColumn("number","Open"),e.addColumn("number","High");var t=this;i(function(e){s(e,!1)});var o=this.svgContainer=d3.select("#overlay").append("svg").attr("width","100%").attr("height",800)},CandlestickChart.util={getDaysInMonth:function(e,t){var n=new Date(e,t,1),r=new Date(e,parseInt(t,10)+1,1);return(r-n)/864e5}};