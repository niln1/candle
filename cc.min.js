// CandlestickChart
// Renders midpoint based candlesticks as a candlestick chart.
// NilN1, 2013
function CandlestickChart(){}google.charts.load("current",{packages:["corechart","controls"]}),CandlestickChart.prototype.render=function(){function n(e){var t=new Date(e),n=""+(t.getMonth()+1),r=""+t.getDate(),i=t.getFullYear();return n.length<2&&(n="0"+n),r.length<2&&(r="0"+r),[i,n,r].join("-")}function r(e,t){t||(t=window.location.href),e=e.replace(/[\[\]]/g,"\\$&");var n=new RegExp("[?&]"+e+"(=([^&#]*)|&|#|$)"),r=n.exec(t);return r?r[2]?decodeURIComponent(r[2].replace(/\+/g," ")):"":null}function i(e){var i=r("tag")?r("tag"):"TWTR",s=Number(r("tspan")?r("tspan"):"90"),o=new Date,a=n(o),l=n((new Date).setDate(o.getDate()-s));$("#csdate").text(l),$("#csymbol").text(i),$("#tag").val(i),$("#tspan").val(s),$("#tag").on("change",function(){document.forms.yo.submit()}),$("#tspan").on("change",function(){document.forms.yo.submit()}),$.get("https://query.yahooapis.com/v1/public/yql?q=select%20*%20from%20yahoo.finance.historicaldata%20where%20symbol%20%3D%20%22"+i+"%22%20and%20startDate%20%3D%20%22"+l+"%22%20and%20endDate%20%3D%20%22"+a+"%22%20&format=json&diagnostics=true&env=store%3A%2F%2Fdatatables.org%2Falltableswithkeys&callback=",function(e){function s(e){var n=t.getSortedRows([{column:1}]),r=t.getValue(n[e],1);return{x:n[e],y:r}}function o(e,t,n,r){var i=e;try{var s=r.getValue(t-1,n),o=r.getValue(t+1,n);return o>i&&s>i?!0:!1}catch(u){return!1}}function a(e,t,n,r){var i=e;try{var s=r.getValue(t-1,n),o=r.getValue(t+1,n);return o<i&&s<i?!0:!1}catch(u){return!1}}function l(e){var t=e.getFilteredRows([{column:1,test:o}]);return t}function c(e){var t=e.getFilteredRows([{column:4,test:a}]);return t}function h(e){var t=i.getChartLayoutInterface(),n=t.getChartAreaBoundingBox(),r=c(e),s=r.map(function(e){return m(e,4)});p(s,function(e,n){if(e.y<n.y){var r=g(e,t,"red-dot"),i=g(n,t,"red-dot"),s=u(r,i).getY,o=d(e,n,function(e){var n=g(m(e,2),t,"");return n.Y<s(n.X)?!0:!1});o==="invalid"?f(i,s,"black",.1):o===!1&&f(i,s,"black")}});var o=s.map(function(e){return g(e,t,"red-dot")}),a=document.querySelector("#chart > div > div");o.forEach(function(e){a.appendChild(e)})}function p(e,t){for(var n=0;n<e.length;n++)for(var r=n+1;r<e.length;r++){var i=e[n],s=e[r];t(i,s)}}function d(e,t,n){var r=!1;for(var i=t.x-1;i>=0;i--)i>e.x?n(i)&&(r=!0):n(i)&&r===!1&&(r="invalid");return r}function v(e){var t=i.getChartLayoutInterface(),n=t.getChartAreaBoundingBox(),r=l(e),s=r.map(function(e){return m(e,1)});p(s,function(e,n){if(e.y>n.y){var r=g(e,t,"green-dot"),i=g(n,t,"green-dot"),s=u(r,i).getY,o=d(e,n,function(e){var n=g(m(e,2),t,"");return n.Y>s(n.X)?!0:!1});o==="invalid"?f(i,s,"black",.1):o===!1&&f(i,s,"black")}});var o=s.map(function(e){return g(e,t,"green-dot")}),a=document.querySelector("#chart > div > div");o.forEach(function(e){a.appendChild(e)})}function m(e,n){var r=t.getValue(e,n);return{x:e,y:r}}function g(e,t,n){var r=e.x,i=e.y,s=t.getYLocation(i),o=t.getXLocation(r),u=document.createElement("div");return u.style.top=s+"px",u.style.left=o+"px",u.className=n,u.X=o,u.Y=s,u}console.log(e);var n=e.query.results.quote;n.forEach(function(e,n){t.addRow([e.Date,Number(e.Low),Number(e.Close),Number(e.Open),Number(e.High)])});var r={legend:"none",hAxis:{direction:-1},candlestick:{fallingColor:{strokeWidth:0,fill:"#a52714",stroke:"#a52714"},risingColor:{strokeWidth:0,fill:"#0f9d58",stroke:"#0f9d58"}},chartArea:{width:"90%",height:"90%"}},i=new google.visualization.CandlestickChart(document.getElementById("chart"));console.log(r),google.visualization.events.addListener(i,"ready",h.bind(i,t)),google.visualization.events.addListener(i,"ready",v.bind(i,t)),i.draw(t,r)})}function o(e,t,n){var n=n?n:"black",r=s.append("line").attr("x1",e.X).attr("y1",e.Y).attr("x2",t.X).attr("y2",t.Y).attr("stroke-width",1).attr("stroke",n)}function u(e,t){function i(e){return n*e+r}function s(e){return(e-r)/n}var n=(t.Y-e.Y)/(t.X-e.X),r=t.Y-n*t.X;return{getY:i,geyX:s}}function a(e,t,n){var t=t?t:"black",n=n?n:1,r=s.append("line").attr("x1",0).attr("y1",e(0)).attr("x2",window.innerWidth).attr("y2",e(window.innerWidth)).attr("stroke-width",1).attr("stroke",t).attr("stroke-opacity",n)}function f(e,t,n,r){var n=n?n:"black",r=r?r:1,i=s.append("line").attr("x1",e.X).attr("y1",e.Y).attr("x2",window.innerWidth).attr("y2",t(window.innerWidth)).attr("stroke-width",.5).attr("stroke",n).attr("stroke-opacity",r)}var e=this,t=new google.visualization.DataTable;t.addColumn("string","Date"),t.addColumn("number","Low"),t.addColumn("number","Close"),t.addColumn("number","Open"),t.addColumn("number","High");var e=this;i(function(e){draw(e,!1)});var s=this.svgContainer=d3.select("#overlay").append("svg").attr("width","100%").attr("height",800)};